<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–ç¶“å†’éšªç‹ - é›¢ç·šç‰ˆ</title>
    <!-- è¼‰å…¥ React èˆ‡ Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Lucide åœ–æ¨™åº« -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .animate-pop {
            animation: pop 0.3s ease-out;
        }
        @keyframes pop {
            0% { transform: scale(0.95); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Lucide Icon çµ„ä»¶åŒ…è£ ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const [svg, setSvg] = useState("");
            useEffect(() => {
                if (window.lucide) {
                    const iconSvg = window.lucide.createIcons();
                }
            }, []);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- åˆå§‹è³‡æ–™ ---
        const LEVEL_LABELS = {
            'åˆç´š': '0~6æ­²',
            'ä¸­ç´š': '7~12æ­²',
            'é«˜ç´š': '13~17æ­²',
            'ç²¾é€²ç´š': '18~30æ­²',
            'å°ˆæ¥­ç´š': '30~ç ”ç©¶è€…'
        };

        const INITIAL_WORLDS = [
            { 
                id: 'lvl1', level: 'åˆç´š', title: "å‰µä¸–çš„å¥‡å¦™", icon: "ğŸŒ±", color: "bg-emerald-500", xp: 100,
                quizzes: [
                    { q: "ç¥åœ¨ç¬¬ä¸€å¤©å‰µé€ äº†ä»€éº¼ï¼Ÿ", o: ["å…‰", "ç©ºæ°£", "é­š", "äºº"], a: 0 },
                    { q: "èª°å»ºé€ äº†æ–¹èˆŸèº²é¿å¤§æ´ªæ°´ï¼Ÿ", o: ["æ‘©è¥¿", "æŒªäº", "å¤§è¡›", "äºä¼¯æ‹‰ç½•"], a: 1 },
                    { q: "è€¶ç©Œé™ç”Ÿåœ¨å“ªå€‹æº«æš–çš„å°åœ°æ–¹ï¼Ÿ", o: ["çš‡å®®", "é¦¬æ§½", "è–æ®¿", "æ—…é¤¨"], a: 1 },
                    { q: "ç¥ç”¨äº†å¹¾å¤©å‰µé€ ä¸–ç•Œï¼Ÿ", o: ["3å¤©", "7å¤©", "6å¤©", "40å¤©"], a: 2 },
                    { q: "å¤§è¡›ç”¨ä»€éº¼æ‰“æ•—äº†å·¨äººæ­Œåˆ©äºï¼Ÿ", o: ["æ©Ÿå¼¦å’ŒçŸ³å­", "é•·çŸ›", "å¼“ç®­", "å¤§åˆ€"], a: 0 }
                ]
            },
            { 
                id: 'lvl2', level: 'ä¸­ç´š', title: "ä¿¡å¿ƒèˆ‡é †æœ", icon: "âš”ï¸", color: "bg-blue-500", xp: 200,
                quizzes: [
                    { q: "ç¥åœ¨è¥¿ä¹ƒå±±è³œä¸‹å¹¾æ¢èª¡å‘½ï¼Ÿ", o: ["5æ¢", "10æ¢", "12æ¢", "7æ¢"], a: 1 },
                    { q: "æ‘©è¥¿å¸¶é ˜ä»¥è‰²åˆ—äººéäº†å“ªç‰‡æµ·ï¼Ÿ", o: ["åœ°ä¸­æµ·", "ç´…æµ·", "é»‘æµ·", "æ­»æµ·"], a: 1 },
                    { q: "æ™ºæ…§ä¹‹ç‹æ˜¯æŒ‡å“ªä¸€ä½ï¼Ÿ", o: ["å¤§è¡›", "ç´¢ç¾…é–€", "æƒç¾…", "å¸Œè¥¿å®¶"], a: 1 }
                ]
            },
            { 
                id: 'lvl4', level: 'ç²¾é€²ç´š', title: "åŸºè¦çœŸç†èˆ‡ç”Ÿæ´»", icon: "ğŸ“œ", color: "bg-indigo-600", xp: 400, 
                quizzes: [
                    { q: "ä¸»è€¶ç©Œåœ¨æœ€å¾Œçš„æ™šå®´ä¸­ï¼Œç‚ºé–€å¾’ç•™ä¸‹äº†ä»€éº¼æ¦œæ¨£ï¼Ÿ", o: ["åˆ†ç™¼é‡‘éŒ¢", "æ´—è…³ç¦®", "å»ºè–æ®¿", "å¯«å®¶æ›¸"], a: 1 },
                    { q: "è–ç¶“ä¸­çš„å®‰æ¯æ—¥æ˜¯æŒ‡ä¸€é€±ä¸­çš„å“ªä¸€å¤©ï¼Ÿ", o: ["æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­", "æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€"], a: 1 },
                    { q: "æ‹œç¥å¿…é ˆç”¨å¿ƒéˆå’Œ____æ‹œç¥‚ï¼Ÿ", o: ["èª å¯¦", "ç¦®ç‰©", "æ­Œæ›²", "æ³•å¾‹"], a: 0 }
                ]
            }
        ];

        function App() {
            const [profile, setProfile] = useState(() => {
                const saved = localStorage.getItem('bible_rpg_profile');
                return saved ? JSON.parse(saved) : null;
            });
            
            const [worlds, setWorlds] = useState(() => {
                const saved = localStorage.getItem('bible_rpg_worlds');
                return saved ? JSON.parse(saved) : INITIAL_WORLDS;
            });

            const [view, setView] = useState(profile ? 'map' : 'welcome');
            const [activeWorld, setActiveWorld] = useState(null);
            const [quizIdx, setQuizIdx] = useState(0);
            const [selectedOpt, setSelectedOpt] = useState(null);
            const [score, setScore] = useState(0);
            const [adminPass, setAdminPass] = useState('');
            const [inputName, setInputName] = useState('');
            const [showClearConfirm, setShowClearConfirm] = useState(false);

            useEffect(() => {
                if (profile) localStorage.setItem('bible_rpg_profile', JSON.stringify(profile));
                localStorage.setItem('bible_rpg_worlds', JSON.stringify(worlds));
                if (window.lucide) window.lucide.createIcons();
            }, [profile, worlds, view]);

            const handleStart = () => {
                if (!inputName.trim()) return;
                setProfile({ name: inputName, xp: 0, completed: [], hero: 'ğŸ›¡ï¸' });
                setView('map');
            };

            const startQuiz = (world) => {
                setActiveWorld(world);
                setQuizIdx(0);
                setScore(0);
                setSelectedOpt(null);
                setView('quiz');
            };

            const checkAnswer = (idx) => {
                if (selectedOpt !== null) return;
                setSelectedOpt(idx);
                const currentQuiz = activeWorld.quizzes[quizIdx];
                const isCorrect = idx === currentQuiz.a;
                if (isCorrect) setScore(s => s + 1);

                setTimeout(() => {
                    if (quizIdx < activeWorld.quizzes.length - 1) {
                        setQuizIdx(q => q + 1);
                        setSelectedOpt(null);
                    } else {
                        const finalScore = score + (isCorrect ? 1 : 0);
                        if (finalScore >= Math.ceil(activeWorld.quizzes.length * 0.6)) {
                            const isAlreadyDone = profile.completed.includes(activeWorld.id);
                            setProfile(prev => ({
                                ...prev,
                                xp: isAlreadyDone ? prev.xp : prev.xp + activeWorld.xp,
                                completed: isAlreadyDone ? prev.completed : [...prev.completed, activeWorld.id]
                            }));
                        }
                        setView('result');
                    }
                }, 600);
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 p-2 md:p-4">
                    <div className="max-w-2xl mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden min-h-[700px] flex flex-col border border-slate-100">
                        
                        {/* Header */}
                        {profile && view !== 'welcome' && (
                            <div className="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-20">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-xl">
                                        {profile.hero}
                                    </div>
                                    <div>
                                        <p className="font-black text-sm">{profile.name}</p>
                                        <p className="text-[10px] font-bold text-slate-400">{profile.xp} XP â€¢ æœ¬æ©Ÿå„²å­˜</p>
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setView('map')} className="p-2 hover:bg-slate-100 rounded-lg"><Icon name="map" /></button>
                                    <button onClick={() => setView('admin_login')} className="p-2 hover:bg-slate-100 rounded-lg"><Icon name="lock" /></button>
                                </div>
                            </div>
                        )}

                        {/* Welcome */}
                        {view === 'welcome' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-10 text-center animate-pop">
                                <div className="text-7xl mb-4">â›ª</div>
                                <h1 className="text-3xl font-black text-indigo-600 mb-2">è–ç¶“å†’éšªç‹</h1>
                                <p className="text-slate-400 text-sm mb-8 font-bold">å…ç™»å…¥é›¢ç·šç‰ˆ</p>
                                <input 
                                    className="w-full max-w-xs p-4 bg-slate-50 rounded-2xl text-center font-bold border-2 mb-4 outline-none focus:border-indigo-400"
                                    placeholder="è¼¸å…¥å†’éšªç¨±è™Ÿ"
                                    value={inputName} 
                                    onChange={e => setInputName(e.target.value)}
                                />
                                <button onClick={handleStart} className="w-full max-w-xs py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">é–‹å§‹æ¢éšª</button>
                            </div>
                        )}

                        {/* Map */}
                        {view === 'map' && (
                            <div className="flex-1 p-6 space-y-6 overflow-y-auto">
                                <h2 className="text-xl font-black flex items-center gap-2">æŒ‘æˆ°é—œå¡</h2>
                                <div className="grid gap-4">
                                    {worlds.map(w => (
                                        <button 
                                            key={w.id} 
                                            onClick={() => startQuiz(w)}
                                            className={`p-5 rounded-3xl border-2 text-left flex items-center gap-4 transition-all ${profile.completed.includes(w.id) ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}
                                        >
                                            <div className={`w-14 h-14 rounded-2xl ${w.color} flex items-center justify-center text-2xl text-white`}>{w.icon}</div>
                                            <div className="flex-1">
                                                <p className="font-black">{w.title}</p>
                                                <p className="text-[10px] text-slate-400 font-bold uppercase">{w.level} â€¢ {LEVEL_LABELS[w.level]}</p>
                                            </div>
                                            {profile.completed.includes(w.id) && <Icon name="check-circle-2" className="text-indigo-500" />}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Quiz */}
                        {view === 'quiz' && activeWorld && (
                            <div className="flex-1 p-6 flex flex-col animate-pop">
                                <div className="flex justify-between items-center mb-8">
                                    <button onClick={() => setView('map')}><Icon name="arrow-left" className="text-slate-400" /></button>
                                    <span className="font-black text-xs text-slate-300">{quizIdx + 1} / {activeWorld.quizzes.length}</span>
                                    <span className="font-black text-indigo-600">{score} ç­”å°</span>
                                </div>
                                <div className="flex-1 flex flex-col justify-center text-center">
                                    <h3 className="text-xl font-black mb-10">{activeWorld.quizzes[quizIdx].q}</h3>
                                    <div className="grid gap-3">
                                        {activeWorld.quizzes[quizIdx].o.map((opt, i) => {
                                            const isCorrect = i === activeWorld.quizzes[quizIdx].a;
                                            const isSelected = selectedOpt === i;
                                            let style = "bg-white border-slate-200";
                                            if (selectedOpt !== null) {
                                                if (isCorrect) style = "bg-emerald-50 border-emerald-500 text-emerald-700";
                                                else if (isSelected) style = "bg-red-50 border-red-500 text-red-700";
                                                else style = "opacity-40";
                                            }
                                            return (
                                                <button 
                                                    key={i} 
                                                    disabled={selectedOpt !== null}
                                                    onClick={() => checkAnswer(i)}
                                                    className={`p-4 rounded-2xl border-2 font-bold transition-all ${style}`}
                                                >
                                                    {opt}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Result */}
                        {view === 'result' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-10 animate-pop">
                                <div className="text-8xl mb-4">{(score / activeWorld.quizzes.length) >= 0.6 ? 'ğŸ†' : 'ğŸ“–'}</div>
                                <h2 className="text-2xl font-black mb-8">æŒ‘æˆ°çµæŸï¼å¾—åˆ†ï¼š{score}</h2>
                                <button onClick={() => setView('map')} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black">è¿”å›åœ°åœ–</button>
                            </div>
                        )}

                        {/* Admin */}
                        {view === 'admin_login' && (
                            <div className="flex-1 flex flex-col items-center justify-center p-10">
                                <h3 className="font-black mb-4 text-slate-400">ç®¡ç†å¾Œå° (å¯†ç¢¼: 1234)</h3>
                                <input 
                                    type="password"
                                    className="p-4 bg-slate-100 rounded-xl text-center font-black outline-none mb-4"
                                    value={adminPass}
                                    onChange={e => setAdminPass(e.target.value)}
                                />
                                <button onClick={() => adminPass === '1234' ? setView('admin_panel') : alert('å¯†ç¢¼éŒ¯èª¤')} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-black">é€²å…¥</button>
                                <button onClick={() => setView('map')} className="mt-4 text-xs font-bold text-slate-300">å–æ¶ˆ</button>
                            </div>
                        )}

                        {view === 'admin_panel' && (
                            <div className="flex-1 p-6 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-black">å¾Œå°ç®¡ç†</h2>
                                    <button onClick={() => setView('map')} className="text-xs font-black p-2 border rounded-lg">é€€å‡º</button>
                                </div>
                                <button onClick={() => { localStorage.clear(); location.reload(); }} className="w-full py-3 bg-red-500 text-white rounded-xl font-black text-sm">æ¸…é™¤æ‰€æœ‰æœ¬åœ°é€²åº¦</button>
                                <p className="text-[10px] text-slate-400 text-center font-bold">é›¢ç·šç‰ˆå»ºè­°ç›´æ¥ä¿®æ”¹ HTML æºç¢¼ä¾†æ–°å¢é¡Œç›®</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
